# CRM Lead Distribution System

Система для автоматического распределения лидов между операторами с учетом их компетенций и нагрузки.

## Технологический стек

- **Python 3.8+**
- **FastAPI** - веб-фреймворк
- **SQLAlchemy** - ORM для работы с базой данных
- **SQLite** - база данных
- **Pydantic** - для валидации данных

## Структура проекта

```
crm_lead_distribution/
├── app/
│   ├── __init__.py
│   ├── main.py                 # Основной файл приложения
│   ├── database.py             # Конфигурация базы данных
│   ├── models/                 # Модели SQLAlchemy
│   │   ├── __init__.py
│   │   ├── operator.py        # Модель оператора
│   │   ├── lead.py            # Модель лида
│   │   ├── source.py          # Модель источника
│   │   └── contact.py         # Модель обращения
│   ├── schemas/                # Схемы Pydantic
│   │   └── schemas.py         # Все схемы для API
│   ├── crud/                   # CRUD операции
│   │   ├── __init__.py
│   │   ├── operator.py        # CRUD для операторов
│   │   ├── lead.py            # CRUD для лидов
│   │   ├── source.py          # CRUD для источников
│   │   └── contact.py         # CRUD для обращений
│   └── services/               # Бизнес-логика
│       ├── __init__.py
│       └── distribution.py    # Сервис распределения лидов
├── requirements.txt
└── README.md
```

## Как запустить проект

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Запустите приложение:
```bash
uvicorn app.main:app --reload
```

Приложение будет доступно по адресу: http://localhost:8000

Документация API будет доступна по адресу: http://localhost:8000/docs

## Описание модели данных

### Оператор (Operator)
- `id` - уникальный идентификатор
- `name` - имя оператора
- `is_active` - активен ли оператор (может получать новые обращения)
- `max_load` - максимальное количество активных лидов/обращений

### Лид (Lead)
- `id` - уникальный идентификатор
- `external_id` - внешний идентификатор для идентификации
- `phone` - телефон для связи
- `email` - email для связи
- `name` - имя клиента
- `created_at` - дата создания

### Источник (Source)
- `id` - уникальный идентификатор
- `name` - название источника/бота
- `description` - описание

### Обращение (Contact)
- `id` - уникальный идентификатор
- `lead_id` - ссылка на лида
- `source_id` - ссылка на источник
- `operator_id` - ссылка на назначенного оператора (может быть null)
- `message` - текст обращения
- `contact_data` - дополнительные данные
- `created_at` - дата создания
- `is_processed` - обработано ли обращение

### Веса операторов по источникам (OperatorSourceWeight)
- `id` - уникальный идентификатор
- `operator_id` - ссылка на оператора
- `source_id` - ссылка на источник
- `weight` - вес/компетенция оператора для данного источника

## Алгоритм распределения

### Идентификация лида
1. Если указан `external_id`, ищем лид по нему
2. Иначе ищем лид по комбинации `phone` + `email`
3. Если не найден - создаем нового лида

### Выбор оператора
1. Находим всех активных операторов, назначенных на данный источник
2. Фильтруем операторов, у которых текущая нагрузка меньше лимита
3. Выбираем оператора с учетом весов:
   - Рассчитываем общий вес всех доступных операторов
   - Генерируем случайное число в диапазоне [0, общий_вес]
   - Определяем оператора, которому соответствует диапазон случайного числа
4. Если подходящих операторов нет - обращение создается без оператора

### Учет нагрузки
- Текущая нагрузка оператора - количество активных (не обработанных) обращений
- Если оператор выбран, но его лимит превышен - выбираем другого оператора
- Если все операторы перегружены - обращение создается без назначения

## API эндпоинты

### Управление операторами
- `POST /operators/` - создать оператора
- `GET /operators/` - получить список операторов
- `GET /operators/{operator_id}` - получить оператора по ID
- `PUT /operators/{operator_id}` - обновить оператора
- `DELETE /operators/{operator_id}` - удалить оператора
- `POST /operators/{operator_id}/sources/{source_id}/weight` - установить вес оператора для источника

### Управление источниками
- `POST /sources/` - создать источник
- `GET /sources/` - получить список источников
- `GET /sources/{source_id}` - получить источник по ID

### Управление лидами
- `POST /leads/` - создать лида
- `GET /leads/` - получить список лидов
- `GET /leads/{lead_id}` - получить лида по ID
- `GET /leads/{lead_id}/contacts` - получить обращения лида

### Управление обращениями
- `POST /contacts/register/` - зарегистрировать новое обращение (с автоматическим распределением)
- `GET /contacts/` - получить список обращений
- `GET /contacts/{contact_id}` - получить обращение с деталями
- `GET /operators/{operator_id}/contacts` - обращения оператора
- `GET /sources/{source_id}/contacts` - обращения источника

### Статистика
- `GET /stats/operator-load` - статистика нагрузки по операторам
- `GET /stats/unprocessed-contacts` - список необработанных обращений

## Примеры использования

### 1. Создание операторов
```bash
curl -X POST "http://localhost:8000/operators/" \
  -H "Content-Type: application/json" \
  -d '{"name": "Оператор 1", "is_active": true, "max_load": 5}'
```

### 2. Создание источников
```bash
curl -X POST "http://localhost:8000/sources/" \
  -H "Content-Type: application/json" \
  -d '{"name": "Telegram Bot", "description": "Бот в Telegram"}'
```

### 3. Настройка весов операторов
```bash
curl -X POST "http://localhost:8000/operators/1/sources/1/weight?weight=2.5"
```

### 4. Регистрация обращения
```bash
curl -X POST "http://localhost:8000/contacts/register/" \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "+79001234567",
    "source_id": 1,
    "message": "Хочу получить консультацию"
  }'
```

## Особенности реализации

- Используется случайный выбор оператора с учетом весов для равномерного распределения нагрузки
- Система корректно обрабатывает случаи, когда один и тот же клиент обращается из разных источников
- Реализован контроль лимитов нагрузки на операторов
- Предоставлен полный набор CRUD операций для всех сущностей
- Добавлена статистика для мониторинга состояния системы
